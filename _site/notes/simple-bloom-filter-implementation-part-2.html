<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Simple Bloom Filter Implementation Part 2</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@pyemma" /><meta name="twitter:title" content="Simple Bloom Filter Implementation Part 2" /><meta name="twitter:description" content="IntroductionIn the last blog, we introduced the initial version of bloom filter. In the first implementation, we only tested our bloom filter on built in type String. This time, we tested in agains..."><meta name="description" content="IntroductionIn the last blog, we introduced the initial version of bloom filter. In the first implementation, we only tested our bloom filter on built in typ..."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/simple-bloom-filter-implementation-part-2"><link rel="alternate" type="application/atom+xml" title="Move Fast and Be Bold" href="/feed.xml" /> <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></head><body><aside class="logo"> <a href="/"> <img src="http://www.gravatar.com/avatar/483a9a64afff77f3c3d40c89212ec7bc.png?s=80" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Simple Bloom Filter Implementation Part 2</h1><time>November 12, 2015</time></div><div class="divider"></div><h3 id="introduction">Introduction</h3><p>In the last <a href="http://pyemma.github.io/notes/Simple-Bloom-Filter-Implementation-Part-I/">blog</a>, we introduced the initial version of bloom filter. In the first implementation, we only tested our bloom filter on built in type <code>String</code>. This time, we tested in against a custom class <code>Person</code>. The idea is simple: we use thrift to define our custom data structure. Thrift will help us create a corresponding <code>Person</code> class. Then we define our own <code>Hashable&lt;Person&gt;</code> to be passed into our bloom filter.</p><h3 id="implementation-details">Implementation details</h3><p>Here is our new thrift file. Notice that we need to assign identifier to each data field, since they would be used for serialize de deserialize data instead of the actual variable name(space consideration).</p><figure class="highlight"><pre><code class="language-text" data-lang="text">struct Person
{
    1: string firstName,
    2: string lastName,
    3: i32 age,
    4: string email
}

service BloomFilterService
{
    // void add(1: string str);
    // bool contain(1: string str);
    void add(1: Person person);
    bool contain(1: Person person);
}</code></pre></figure><p>If we run the command <code>thrift -r -gen java bloomfilterservice.thrift</code>, the content in <code>gen-java</code> would also contain a generated <code>Person</code> class. We need to implement a <code>Hashable&lt;Person&gt;</code> type to hash a <code>Person</code> object into several integers. Here, the method I used is very simple, it still take a prime and the result would be a combination of all data fields.</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersonHash</span> <span class="kd">implements</span> <span class="n">Hashable</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">prime</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PersonHash</span><span class="o">(</span><span class="kt">int</span> <span class="n">prime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prime</span> <span class="o">=</span> <span class="n">prime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">firstName</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">firstName</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">firstName</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span>  <span class="o">=</span> <span class="n">sum</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="n">firstName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">lastName</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">lastName</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lastName</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="n">lastName</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="na">email</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">email</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">+</span> <span class="n">email</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">prime</span> <span class="o">*</span> <span class="n">person</span><span class="o">.</span><span class="na">age</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The remaining is all every simple, we passed in a list of <code>PersonHash</code> object into handler and replace <code>String</code> with <code>Person</code> at correct places. Then all is done.</p><h3 id="notes">Notes</h3><ul><li>When I was trying to implement this part, I was planed to create a <em>general</em> bloom filter, that is utilize Java’s template feature. However, I failed. Since I don’t know how to define an API with template type in thrift.</li><li>The package in Java is quite important and I have always ignore it before. During the implementation, I initially put <code>PersonHash</code> under <code>bloomfilter</code> package. This class need to access <code>Person</code> class generated by thrift, however, <code>Person</code> class is under the root package and <code>PersonHash</code> could not access it. I was confused by this problem for a long time.</li></ul><h3 id="next-step">Next step</h3><ul><li>Try if thrift support function overload. Have function for <code>String</code> and <code>Person</code> at the same time to see if it still works.</li><li>Currently, I only tried it with toy data. I decided to move on to some real data to test the performance of bloom filter.</li><li>Add some performance measure code.</li></ul></article><div class="back"> <a href="/">Back</a></div></main></body></html>