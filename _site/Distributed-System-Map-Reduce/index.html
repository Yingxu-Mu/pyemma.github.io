<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.9.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>MIT Distributed System Course - MapReduce - Coding Monkey</title>
<meta name="description" content="Introduction">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Coding Monkey">
<meta property="og:title" content="MIT Distributed System Course - MapReduce">
<meta property="og:url" content="https://pyemma.github.io/Distributed-System-Map-Reduce/">


  <meta property="og:description" content="Introduction">







  <meta property="article:published_time" content="2020-07-25T00:00:00-07:00">





  

  


<link rel="canonical" href="https://pyemma.github.io/Distributed-System-Map-Reduce/">







  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Yang Pei",
      "url" : "https://pyemma.github.io",
      "sameAs" : null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="https://pyemma.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Coding Monkey Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://pyemma.github.io/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="https://pyemma.github.io/">Coding Monkey</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/" >Quick-Start Guide</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Yang Pei</h3>
    
    
      <p class="author__bio" itemprop="description">
        I am a Coding Monkey
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Mountain View</span>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="MIT Distributed System Course - MapReduce">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="July 25, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">MIT Distributed System Course - MapReduce
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  10 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="introduction">Introduction</h2>

<p>This is going to be a series of posts to record my learning of <a href="https://pdos.csail.mit.edu/6.824/schedule.html">MIT 6.824 Distributed System</a>. The post would focus on the course assignments which is to build some distributed systems from scratch using <a href="https://golang.org/">Go language</a>. I would discuss some of the basic ideas that these assignments touched, as well as the reason I reached to the design decision of my implementation. For the code, here is some disclaimers:</p>
<ul>
  <li>The implementation would guaratee to pass the test script provided by the course</li>
  <li>The implementation might not be in the most optimal status, I might have follow up posts to refactor the implementation later</li>
  <li>The implementation might not be in the cleanest way, as I’m still learning Go language</li>
</ul>

<h2 id="mapreduce">MapReduce</h2>
<p>MapReduce has been known for a long time as a framework to handle large scale data processing jobs. <strong><em>The first assignment is to build a simple version of MapReduce to do word count (a classic demo application for MapReduce xD)</em></strong>.</p>

<p>The original <a href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">MapReduce paper</a> includes lots of details about how it works overall and some tricks Google applied in their implementation. Here is a summary of some key points.</p>

<p>There are two types of machines in the system:</p>
<ul>
  <li>Master: Coordinate the entire process, schedule Map/Reduce task to workers, store necessary metadata to track the progress of the process</li>
  <li>Worker: Do the actual Map/Reduce task with users’ program</li>
</ul>

<p>and there are two types of task:</p>

<ul>
  <li>Map: Read a split of data assigned and pass it to users’ map functions, generate intermediate key/value paris and store them in local files, propagate intermediate files to master</li>
  <li>Reduce: Read all intermediate files according to some partition functions which distribute key/value pairs to different intermediate files, sort key/value pairs and pass to users’ reduce function, then output to final files</li>
</ul>

<p>There are some tricks mentioned in the paper to improve the performance:</p>
<ul>
  <li>Locality, Map task is scheduled to the machine where the input splits stored. This helps save the precious network bandwidth.</li>
  <li>Backup task is scheduled to resolve the straggler issue, which is the case that some workers are making progress unexpected slow.</li>
  <li>Heartbeat is used by master to check the status of workers</li>
  <li>If a worker failed, then all the Map task completed by the worker would be reset to idle. The Map task and Reduce task in progress would also be reset to idle.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>The full implementation is available <a href="https://github.com/pyemma/mit-distributed-system/tree/master/src/mr">here</a>.</p>

<h3 id="rpc">RPC</h3>
<p>In this assignment, master and worker communicate via RPC calls. For example, a worker schedules a RPC call to master to get a task to work, and notifies master that the task has been finished via another RPC call. Here is a list of RPC in my implementation:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Master</span><span class="p">)</span> <span class="n">RegisterWorkerId</span><span class="p">(</span><span class="n">args</span> <span class="o">*</span><span class="n">RegisterWorkerIdArgs</span><span class="p">,</span> <span class="n">reply</span> <span class="o">*</span><span class="n">RegisterWorkerIdReply</span><span class="p">)</span> <span class="kt">error</span>

<span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Master</span><span class="p">)</span> <span class="n">RequestJob</span><span class="p">(</span><span class="n">args</span> <span class="o">*</span><span class="n">RequestJobArgs</span><span class="p">,</span> <span class="n">reply</span> <span class="o">*</span><span class="n">RequestJobReply</span><span class="p">)</span> <span class="kt">error</span>

<span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Master</span><span class="p">)</span> <span class="n">FinishJob</span><span class="p">(</span><span class="n">args</span> <span class="o">*</span><span class="n">FinishJobArgs</span><span class="p">,</span> <span class="n">reply</span> <span class="o">*</span><span class="n">FinishJobReply</span><span class="p">)</span> <span class="kt">error</span></code></pre></figure>

<ul>
  <li>
    <p>RegisterWorkerId is the first RPC call each worker would schedule once up. This call is to register itself within master’s in memory status tracker so that master is aware of its existence and assigns it a unique identifer. The reason of this behavior is that master might need to reschedule a task to other workers if the original worker is a straggler. And the master need to use this identifier to check if the result is returned from the new worker instead of the staled work for the sake of security.</p>
  </li>
  <li>
    <p>RequestJob is a RPC call that workers call repeatedly. Master would assign a task for it if there is any task could be schedule to this worker or reply there is no available task. Once all tasks are done, a dedicated status would be returned to workers so that they could safely exits.</p>
  </li>
  <li>
    <p>FinishJob is a RPC call that workers call once the assigned work is done. Worker would also pass necessary information via this RPC call to master.</p>
  </li>
</ul>

<h3 id="master-record-data-structure">Master Record Data Structure</h3>

<p>As master is the coordinator for all workers, it is critical for master to keep track of all workers’ progress. In this assignment, I highlight the following points for master to take care of:</p>
<ul>
  <li>Workers that are registered within the system and their identifiers.</li>
  <li>Map/Reduce task identifiers. I made a simplification that, number of input files is tantamount to the number of map tasks. The number of reduce tasks is a parameter passed in once master is up.</li>
  <li>Map/Reduce task status. There are in total 3 status: Not Scheduled/Pending/Done. If a task is in pending status, we would also record the worker id that is assigned with this task. This information is critical because the worker might fail or be straggle on the task. To avoid infinite waiting, master has a timeout of 10s on each task scheduled. So there might be cases that, some workers are straggle and would respond after 10s when master has already assigned the task to another worker. We would like to reject the response by this straggler worker. So only when the worker identifier matches master’s record, the response would be accepted.</li>
  <li>Map task input filenames and intermediate filenames.</li>
  <li>2 boolean parameters to check if all map tasks are done and all reduce tasks are done.</li>
  <li>A mutex is used to lock the master data structure. The reason is that Go process each RPC call via treads and each tread is sharing the same copy of the record. To avoid racing condition, each thread needs to first acquire the lock and then does the necessary update.</li>
</ul>

<p>Below is a piece of the code</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">Master</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// need to lock the object in concurrent env</span>
	<span class="n">mu</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
	<span class="c">// use an array to record all workers, we need to use this to reject</span>
	<span class="c">// reply from workers that dead or straggle</span>
	<span class="n">workers</span> <span class="p">[]</span><span class="kt">int</span>
	<span class="c">// use a array here to store the mapper input filenames, this is</span>
	<span class="c">// used to generate the mapper task id</span>
	<span class="n">mapperFilenames</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="c">// use a dict here to store the status of mapper job</span>
	<span class="n">mapperStatus</span> <span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="n">JobStatus</span>
	<span class="c">// use a map to store reducer input filenames</span>
	<span class="n">reducerFilenames</span> <span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">string</span>
	<span class="c">// use a dict here to store the status of reducer job</span>
	<span class="n">reducerStatus</span>  <span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="n">JobStatus</span>
	<span class="n">numReducer</span>     <span class="kt">int</span>
	<span class="n">mapperAllDone</span>  <span class="kt">bool</span>
	<span class="n">reducerAllDone</span> <span class="kt">bool</span>
<span class="p">}</span></code></pre></figure>

<h3 id="master">Master</h3>

<p>Master implements the three RPC APIs mentioned in <a href="#rpc">RPC</a>. I would skip RegisterWorkerId as it is pretty straight forward to implement and mainly focus on the RequestJob and FinishJob RPC call.</p>

<blockquote>
  <p><strong><em>RequestJob</em></strong></p>
</blockquote>

<p>For RequestJob, all map tasks need to be done before the scheduling of any reduce task. The master would first lock the record, and see if there is any map task available. Once all map tasks are done, the corresponding flag would be enabled, and master would check if there is any available reduce task. Master would reply with a data type RequestJobReply.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">RequestJobReply</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">JobType</span>    <span class="kt">string</span>   <span class="c">// map/reduce job</span>
	<span class="n">JobId</span>      <span class="kt">int</span>      <span class="c">// map/reduce job id</span>
	<span class="n">Filenames</span>  <span class="p">[]</span><span class="kt">string</span> <span class="c">// the input filename to map/reduce job</span>
	<span class="n">NumReducer</span> <span class="kt">int</span>      <span class="c">// number of reduce tasks in total</span>
<span class="p">}</span></code></pre></figure>

<ul>
  <li>JobType is to tell worker this is Map task or Reduce task.</li>
  <li>JobId is the identifier assigned by master to track the job’s status.</li>
  <li>Filenames could be the map input filenames or intermediate filenames generated by worker.</li>
  <li>NumReducer is required to tell how many intermediate files we need to generate and shard the keys accordingly.</li>
</ul>

<blockquote>
  <p><strong><em>FinishJob</em></strong></p>
</blockquote>

<p>For FinishJob, master would read the result generated by workers and update the corresponding record. The logic of reduce task is pretty simple. For map task, master needs to parse the returned filenames and figures out the target reduce task id. For all map/reduce task, we need to check if the status is Pending and the worker id on record matches the worker id in the request before updating the record.</p>

<p>Here is the structure of the FinishJob request, which is constructed by worker and send to master:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">type</span> <span class="n">FinishJobArgs</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">JobType</span>   <span class="kt">string</span>
	<span class="n">JobId</span>     <span class="kt">int</span>
	<span class="n">WorkerId</span>  <span class="kt">int</span>      <span class="c">// worker id</span>
	<span class="n">Filenames</span> <span class="p">[]</span><span class="kt">string</span> <span class="c">// filenames that are generated</span>
<span class="p">}</span></code></pre></figure>

<p>Here is the logic of parsing filenames and updating the corresponding record:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">case</span> <span class="n">Map</span><span class="o">:</span>
    <span class="c">// Mark the corresponding Map job finished, and flash the intermediate file</span>
    <span class="n">jobId</span> <span class="o">:=</span> <span class="n">args</span><span class="o">.</span><span class="n">JobId</span>
    <span class="n">filenames</span> <span class="o">:=</span> <span class="n">args</span><span class="o">.</span><span class="n">Filenames</span>
    <span class="c">// There might be duplicated job due to straggler, check the status to see if</span>
    <span class="c">// the reply matches our record</span>
    <span class="n">jobStatus</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">mapperStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">jobStatus</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="n">Pending</span> <span class="o">&amp;&amp;</span> <span class="n">jobStatus</span><span class="o">.</span><span class="n">WorkerId</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">WorkerId</span> <span class="p">{</span>
        <span class="n">m</span><span class="o">.</span><span class="n">mapperStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="p">{</span><span class="n">Status</span><span class="o">:</span> <span class="n">Done</span><span class="p">,</span> <span class="n">WorkerId</span><span class="o">:</span> <span class="o">-</span><span class="m">1</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">filenames</span> <span class="p">{</span>
            <span class="n">token</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"-"</span><span class="p">)</span>
            <span class="n">reducerId</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">ParseInt</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">],</span> <span class="m">10</span><span class="p">,</span> <span class="m">64</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">reducerFilenames</span><span class="p">[</span><span class="kt">int</span><span class="p">(</span><span class="n">reducerId</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">reducerFilenames</span><span class="p">[</span><span class="kt">int</span><span class="p">(</span><span class="n">reducerId</span><span class="p">)],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<blockquote>
  <p><strong><em>CheckStatus</em></strong></p>
</blockquote>

<p>As mentioned in <a href="#master-record-data-structure">Master Record Data Structure</a>, master has a timeout of 10s on each task scheduled. Once the task has been timeout, master would put the task back to Not Scheduled status so that it could be allocated to other workers, and clear the worker id on the record. This is achieved by firing a goroutines of func CheckStatus each time we schedule a task to a worker. Function CheckStatus would first sleep 10s and then check the status of the task. If the task is still in Pending status, then it would put it back to Not Scheduled status, otherwise it would directly return.</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Master</span><span class="p">)</span> <span class="n">CheckStatus</span><span class="p">(</span><span class="n">jobType</span> <span class="kt">string</span><span class="p">,</span> <span class="n">jobId</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span> <span class="o">*</span> <span class="m">10</span><span class="p">)</span>
	<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">jobType</span> <span class="o">==</span> <span class="n">Map</span> <span class="p">{</span>
		<span class="n">jobStatus</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">mapperStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">jobStatus</span><span class="o">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">Done</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">.</span><span class="n">mapperStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="p">{</span><span class="n">Status</span><span class="o">:</span> <span class="n">NotScheduled</span><span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">jobStatus</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">reducerStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">jobStatus</span><span class="o">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">Done</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">.</span><span class="n">reducerStatus</span><span class="p">[</span><span class="n">jobId</span><span class="p">]</span> <span class="o">=</span> <span class="n">JobStatus</span><span class="p">{</span><span class="n">Status</span><span class="o">:</span> <span class="n">NotScheduled</span><span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="worker">Worker</h3>

<p>Worker takes user’s customization map and reduce function as input. In this assignment, this is done via Go plug-ins. Once a worker is up, the first thing it tries to do is to call the RegisterWorkerId RPC to let the master know its existence and assign it an identifier. Each worker would have a unique identifier and this is guaranteed by the master. It then enters an infinite loop. Within the loop, the worker would try to first get a task from the master. Once it gets a map task:</p>
<ul>
  <li>Read in the file content</li>
  <li>Pass all content into mapf function, which is the users’ map function</li>
  <li>Shard the output according to the num of reduce tasks</li>
  <li>Write all content into a temp file and then atomically rename it following the convention of <code class="highlighter-rouge">out-X-Y</code>, where X is the map task id and Y is the reduce task id
    <ul>
      <li>The reason that we write into a temp file is that we don’t want to expose any partially written file. Only when all content is flushed into the file, we would formally rename it to the acceptable intermediate filename.</li>
    </ul>
  </li>
  <li>Call FinishJob with the map task id, worker id and all intermediate filenames generated to the master</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">case</span> <span class="n">Map</span><span class="o">:</span>
    <span class="n">filename</span> <span class="o">:=</span> <span class="n">reply</span><span class="o">.</span><span class="n">Filenames</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">content</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">kva</span> <span class="o">:=</span> <span class="n">mapf</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="kt">string</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

    <span class="c">// shard the kv into nReducer splits</span>
    <span class="n">kvSharded</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="n">KeyValue</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">kv</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">kva</span> <span class="p">{</span>
        <span class="n">shard</span> <span class="o">:=</span> <span class="n">ihash</span><span class="p">(</span><span class="n">kv</span><span class="o">.</span><span class="n">Key</span><span class="p">)</span> <span class="o">%</span> <span class="n">numReducer</span>
        <span class="n">kvSharded</span><span class="p">[</span><span class="n">shard</span><span class="p">]</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">kvSharded</span><span class="p">[</span><span class="n">shard</span><span class="p">],</span> <span class="n">kv</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c">// Flash the result to files</span>
    <span class="k">for</span> <span class="n">shard</span><span class="p">,</span> <span class="n">kva</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">kvSharded</span> <span class="p">{</span>
        <span class="n">tempfile</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">TempFile</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="s">"mr-tempfile"</span><span class="p">)</span>
        <span class="c">// Use json format to store the result in intermeidate file</span>
        <span class="n">enc</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">NewEncoder</span><span class="p">(</span><span class="n">tempfile</span><span class="p">)</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kva</span><span class="p">)</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="n">interFilename</span> <span class="o">:=</span> <span class="s">"mr-"</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">JobId</span><span class="p">)</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">shard</span><span class="p">)</span>  <span class="c">// mr-X-Y</span>
        <span class="n">os</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span> <span class="n">interFilename</span><span class="p">)</span>
        <span class="n">intermediate</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">intermediate</span><span class="p">,</span> <span class="n">interFilename</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">FinishJob</span><span class="p">(</span><span class="n">workerId</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">JobType</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">JobId</span><span class="p">,</span> <span class="n">intermediate</span><span class="p">)</span></code></pre></figure>

<p>Once it gets a reduce task:</p>
<ul>
  <li>Read all intermediate files content</li>
  <li>Sort all keys</li>
  <li>Pass to reducef. This part of logic is provided by the assignment example</li>
  <li>Flush result into temp file and once everything is done rename it to <code class="highlighter-rouge">out-X</code> where X is the reduce task id</li>
</ul>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">case</span> <span class="n">Reduce</span><span class="o">:</span>
    <span class="c">// Read values from all intermediate file</span>
    <span class="n">kva</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">KeyValue</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">reply</span><span class="o">.</span><span class="n">Filenames</span> <span class="p">{</span>
        <span class="n">file</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">kvs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">KeyValue</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dec</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvs</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"fail to read intermediate file"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">kva</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">kva</span><span class="p">,</span> <span class="n">kvs</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">sort</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">ByKey</span><span class="p">(</span><span class="n">kva</span><span class="p">))</span>

    <span class="n">oname</span> <span class="o">:=</span> <span class="s">"mr-out-"</span> <span class="o">+</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Itoa</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">JobId</span><span class="p">)</span>
    <span class="n">tempfile</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">TempFile</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="s">"mr-tempfile"</span><span class="p">)</span>
    <span class="c">// This part of code is copied from the course example code</span>
    <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">kva</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">j</span> <span class="o">:=</span> <span class="n">i</span> <span class="o">+</span> <span class="m">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">kva</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">kva</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">Key</span> <span class="o">==</span> <span class="n">kva</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Key</span> <span class="p">{</span>
            <span class="n">j</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="n">values</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="o">:=</span> <span class="n">i</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span> <span class="p">{</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">kva</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">output</span> <span class="o">:=</span> <span class="n">reducef</span><span class="p">(</span><span class="n">kva</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">tempfile</span><span class="p">,</span> <span class="s">"%v %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">kva</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
    <span class="p">}</span>
    <span class="n">tempfile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span> <span class="n">oname</span><span class="p">)</span>
    <span class="n">intermediate</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">intermediate</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>

    <span class="n">FinishJob</span><span class="p">(</span><span class="n">workerId</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">JobType</span><span class="p">,</span> <span class="n">reply</span><span class="o">.</span><span class="n">JobId</span><span class="p">,</span> <span class="n">intermediate</span><span class="p">)</span></code></pre></figure>

<p>Once the worker receives None flag from RequestJob response, it would sleep for 2s and then continues. Once it receives AllDone, it would break the loop and exit.</p>

<h2 id="future-plan">Future Plan</h2>

<p>This is just a naive implementation and there are several points that could be optimized.</p>
<ul>
  <li>The master data structure could be simplified, e.g.
    <ul>
      <li>Map/Reduce task status could be merged into a single one</li>
      <li>We could keep a queue to check if there are still map/reduce tasks not scheduled yet</li>
    </ul>
  </li>
  <li>The logic within worker’s map/reduce processing could be optimized, e.g.
    <ul>
      <li>When we write and read intermediate file, we are processing sequentially. But we could actually do this concurrently by splitting the work of each intermediate file into a goroutine</li>
    </ul>
  </li>
</ul>

<p>Please leave any comment and feedback you have :)</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://pyemma.github.io/tags/#distributed-system" class="page__taxonomy-item" rel="tag">distributed system</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-07-25T00:00:00-07:00">July 25, 2020</time></p>
        
      </footer>

      
  <nav class="pagination">
    
      <a href="https://pyemma.github.io/DQN-In-Practice/" class="pagination--pager" title="DQN In Practice
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="https://pyemma.github.io/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Yang Pei. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="https://pyemma.github.io/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "https://pyemma.github.io/Distributed-System-Map-Reduce/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/Distributed-System-Map-Reduce"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://pyemma.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
